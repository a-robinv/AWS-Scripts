#Set the value of parameters
read -p "Enter Customer Account Name(CLIENTNAME-ALIAS): " CLIENT_ACCOUNT
read -p "Enter SNS TOPIC " SNS_TOPIC
read -p "Enter Region " REGION
read -p "Enter Environment " ENVIRONMENT

CRITICAL_CPU="80"
CRITICAL_MEMORY="80"
CRITICAL_DISK="80"
CRITICAL_PERIOD="60"
CRITICAL_EVALPERIOD="1"


aws ec2 describe-instances \
  --filters Name=platform-details,Values="Linux/UNIX" "Name=tag:Environment,Values=${ENVIRONMENT}" \
  --query 'Reservations[*].Instances[*].[InstanceId, ImageId, InstanceType, Tags[?Key==`Name`].Value]' \
  --output text \
  --region ${REGION} >> create-cwmemoryalarm-linux-platform.txt
aws ec2 describe-instances \
  --filters Name=platform-details,Values="Red Hat Enterprise Linux" "Name=tag:Environment,Values=${ENVIRONMENT}" \
  --query 'Reservations[*].Instances[*].[InstanceId, ImageId, InstanceType, Tags[?Key==`Name`].Value]' \
  --output text \
  --region ${REGION} >> create-cwmemoryalarm-linux-platform.txt
aws ec2 describe-instances \
  --filters Name=platform-details,Values="SUSE Linux" "Name=tag:Environment,Values=${ENVIRONMENT}" \
  --query 'Reservations[*].Instances[*].[InstanceId, ImageId, InstanceType, Tags[?Key==`Name`].Value]' \
  --output text \
  --region ${REGION} >> create-cwmemoryalarm-linux-platform.txt

#MEMORY UTILIZATION

while read instance_id; read instance_name;
do aws cloudwatch put-metric-alarm --alarm-name "${CLIENT_ACCOUNT} - P3 - Critical Memory Utilization on $instance_id ($instance_name)" --alarm-description "Alarm when Memory exceeds threshold" --metric-name mem_used_percent --namespace CWAgent --statistic Average --period $CRITICAL_PERIOD --threshold $CRITICAL_MEMORY --comparison-operator GreaterThanThreshold --dimensions "Name=InstanceId,Value=$instance_id" --evaluation-periods $CRITICAL_EVALPERIOD --alarm-actions ${SNS_TOPIC} --unit Percent --region ${REGION};
done < create-cwmemoryalarm-linux-platform.txt;